<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Article 40620770277267</title>
</head>
<body>
    <pre>{
  "id": 40620770277267,
  "url": "https://Criscras13.github.io/KB_Transformer/api/v2/help_center/en-us/articles/40620770277267.json",
  "html_url": "https://Criscras13.github.io/KB_Transformer/api/v2/help_center/en-us/articles/40620770277267.html",
  "author_id": 31899104510995,
  "comments_disabled": true,
  "draft": false,
  "promoted": false,
  "position": 0,
  "vote_sum": 0,
  "vote_count": 0,
  "section_id": 42972312463891,
  "created_at": "2025-04-24T10:17:02Z",
  "updated_at": "2025-07-14T14:30:21Z",
  "name": "Prevent - Gateway Configuration",
  "title": "Prevent - Gateway Configuration",
  "source_locale": "en-us",
  "locale": "en-us",
  "outdated": false,
  "outdated_locales": [],
  "edited_at": "2025-07-11T20:08:24Z",
  "user_segment_id": null,
  "permission_group_id": 195648,
  "content_tag_ids": [],
  "label_names": [],
  "body": "<p>The gateway ensures that our services can support non-Microsoft Outlook mail flow from sources such as mobile devices or backend systems. The gateway serves as a critical backup mechanism for the web add-in. In scenarios when the add-in becomes unavailable, the gateway automatically assumes responsibility as a secondary checkpoint, analyzing emails that would otherwise go unscreened. This redundant security architecture ensures continuous protection even when primary systems are unavailable or experiencing downtime.</p>\n<h2 id='h_01JSKJAAZNQZV8JMF5YQ1NDVZD'>Gateway Components</h2>\n<p>The gateway consists of the following components:</p>\n<ul>\n<li>Accepted Domain\n<ul>\n<li>Configuring an accepted domain allows us to route emails to the gateway for processing. We do not configure an MX record, but we use an MX record value.</li>\n</ul>\n</li>\n<li>Connectors\n<ul>\n<li>Connectors allow emails to be transmitted between Microsoft 365 and the gateway over TLS 1.2, using the Microsoft recommended Certificate Authority (CA) issued certificate-based authentication.</li>\n</ul>\n</li>\n<li>Microsoft 365 Group\n<ul>\n<li>The transport rules created below are scoped to apply to a Microsoft 365 group. Users of Prevent will need to be manually added to this Microsoft 365 group.</li>\n</ul>\n</li>\n<li>Moderation Mailbox\n<ul>\n<li>The moderation mailbox allows emails to be analyzed without the requirement of the web add-in.</li>\n<li>If the moderation mailbox detects a risk, a verification email is sent to the sender, requiring them to approve or reject the sending of the email.</li>\n<li>If the Microsoft Outlook add-in becomes unavailable, the moderation mailbox allows the gateway to analyze emails instead. If the moderation mailbox is not configured, emails will be sent unchecked.</li>\n<li>The web add-in uses a timeout mechanism to reduce delays during email transmission. This system automatically switches to using the moderation mailbox when the add-in experiences interruptions or network issues, ensuring email workflow continuity.</li>\n</ul>\n</li>\n<li>Transport Rules\n<ul>\n<li>Two transport rules are required. The first rule detects which emails are to be redirected to the gateway. The second rule detects any emails sent to the shared mailbox, typically approves or rejects responses, and redirects them to the gateway.</li>\n</ul>\n</li>\n</ul>\n<h2 id='h_01JSKJC1M7Q7P09YSTD0NPZMTD'>Prerequisites</h2>\n<p>Before you get started, please ensure you have the following:</p>\n<ul>\n<li>Microsoft 365 tenant</li>\n<li>Global admin rights to your organization's Microsoft 365 admin portal</li>\n</ul>\n<h2 id='h_01JSKJCNN21KVVS62XP921ZTAH'>Configuration Steps</h2>\n<p>Complete the steps in the sections below to configure your gateway.</p>\n<h3 id='h_01JSKK2E48FE041C9SYH0F5EG2'>Graph API Ingestion</h3>\n<p>For Prevent to function properly, ingested metadata is required. Graph API ingestion requires an app registration for your Entra ID tenant. This ingestion can be done manually in the Entra ID administration platform. Global Administrator credentials are required. To configure Graph API ingestion, follow the steps below:</p>\n<ol>\n<li>Log in to your Entra ID portal.</li>\n<li>Navigate to <strong>App registrations </strong>&gt; <strong>New registration</strong>.</li>\n<li>Populate the settings as below:\n<ol>\n<li>Name: Prevent</li>\n<li>Who can use this application or access this API?: Accounts in this organizational directory only (Single Tenant)</li>\n</ol>\n</li>\n<li>Select <strong>Register</strong>.</li>\n<li>Navigate to <strong>Authentication </strong>&gt; <strong>Add a platform</strong> &gt; <strong>Mobile and desktop applications</strong>.</li>\n<li>Select the URL ending with /nativeclient and select <strong>Configure</strong>.</li>\n<li>Add a new redirect URL with the value \u201curn:ietf:wg:oauth:2.0:oob\u201d.</li>\n<li>Under <strong>Advanced Settings</strong>, enable <strong>Allow public client flows </strong>by selecting <strong>Yes</strong>\n</li>\n<li>Click <strong>Save</strong>.</li>\n<li>Navigate to <strong>API Permissions </strong>&gt;<strong> Add a permission</strong>.</li>\n<li>Add the following permissions:\n<ol>\n<li>\n<strong>Microsoft Graph</strong> &gt; <strong>Application Permissions</strong> &gt; <strong>User</strong> &gt; <strong>User.Read.All</strong>\n</li>\n<li>\n<strong>Microsoft Graph</strong> &gt;<strong> Application Permissions </strong>&gt;<strong> Group</strong> &gt; <strong>Group.Read.All</strong>\n</li>\n<li>\n<strong>Microsoft Graph</strong> &gt; <strong>Application Permissions</strong> &gt; <strong>Mail</strong> &gt; <strong>Mail.Read</strong>\n</li>\n</ol>\n</li>\n<li>Click <strong>Add Permissions</strong>.</li>\n<li>Navigate to <strong>Certificates and Secrets</strong>. Add a new client secret with an expiry of 24 months. Copy the value of the secret immediately after creation. Your KnowBe4 engineer will need this value.</li>\n<li>Navigate to the <strong>Overview </strong>page and make note of the <strong>Application (client) ID </strong>and <strong>Directory (tenant) ID</strong>. Your KnowBe4 engineer will need these values.</li>\n<li>Pass the following information to your KnowBe4 engineer:\n<ol>\n<li>Application (client) ID</li>\n<li>Directory (tenant) ID</li>\n<li>Client secret value and date of expiry</li>\n</ol>\n</li>\n</ol>\n<h3 id='h_01JSKKDHANBTBG0FH6X6HT2RQK'>Accepted Domain</h3>\n<p>To configure an accepted domain, follow the steps below:</p>\n<ol>\n<li>Log in to the Microsoft 365 admin portal.</li>\n<li>Navigate to <strong>Setup</strong>.</li>\n<li>Under <strong>Get your custom domain set up</strong>, select <strong>View </strong>&gt; <strong>Manage</strong> &gt; <strong>Add domain</strong>.</li>\n<li>Configure the new domain using the gateway domain address provided by your KnowBe4 engineer.</li>\n</ol>\n<h3 id='h_01JSKKS3X3YMKGR82038BAV0ET'>Connectors</h3>\n<p>To configure a send connector, follow the steps below:</p>\n<ol>\n<li>Log in to the Microsoft 365 admin portal.</li>\n<li>Navigate to <strong>Mail Flow</strong> &gt; <strong>Connectors</strong>.</li>\n<li>Click <strong>+ Add a Connector</strong>.</li>\n<li>Set the mail flow scenario to be from <strong>Microsoft 365</strong> to <strong>Partner Organization</strong>.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Enter a name for the connector.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Select the option to use the only connector with a transport rule associated with it.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Select <strong>Route email through these smart hosts</strong>.</li>\n<li>Add the hostnames provided by your KnowBe4 engineer.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Select <strong>Always use Transport Layer Security (TLS) </strong>to secure the connection.</li>\n<li>Select <strong>Add the subject name</strong> and enter the hostnames provided by your KnowBe4 engineer.</li>\n<li>Click <strong>Next</strong>.</li>\n</ol>\n<p>To configure a receive connector, follow the steps below:</p>\n<ol>\n<li>Log in to the Microsoft 365 admin portal.</li>\n<li>Navigate to <strong>Mail Flow</strong> &gt; <strong>Connectors</strong>.</li>\n<li>Click <strong>+ Add a Connector</strong>.</li>\n<li>Set the mail flow scenario to be from <strong>Your Organization</strong> to <strong>Microsoft 365</strong>.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Enter a name for the connector.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Enter the hostnames provided by your KnowBe4 engineer.</li>\n</ol>\n<h3 id='h_01JSKKXFBEYSR1JXZ4EFA57MRM'>Microsoft 365 Group</h3>\n<p>To create the Microsoft group of Prevent users, follow the steps below:</p>\n<ol>\n<li>Log in to the Microsoft 365 admin portal.</li>\n<li>Navigate to <strong>Active Teams and Groups</strong>.</li>\n<li>Select <strong>Add a Microsoft 365 group</strong>.</li>\n<li>Enter a name for the group.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Assign an owner of the group.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Add the required members to the group.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Enter a group email address, such as <a href='mailto:KnowBe4_Prevent_Users@domain.com'>KnowBe4_Prevent_Users@domain.com</a>.</li>\n<li>Use the <strong>Privacy </strong>drop-down menu to select <strong>Private</strong>.</li>\n<li>Unselect the <strong>Create a team for this group</strong> check box.</li>\n<li>Click <strong>Next</strong>.</li>\n<li>Review and create the group.</li>\n</ol>\n<h3 id='h_01JSKM1TECQP49WV100QBNNQMT'>Moderation Mailbox</h3>\n<p>To create the moderation mailbox, follow the steps below:</p>\n<ol>\n<li>Log in to the Microsoft 365 admin portal.</li>\n<li>Navigate to <strong>Teams &amp; Groups</strong> &gt; <strong>Shared mailboxes</strong>.</li>\n<li>Click <strong>+ Add a shared mailbox</strong>.</li>\n<li>The mailbox address should be <a href='mailto:Egress_Moderator@domain.com'>Egress_Moderator@domain.com</a>.</li>\n<li>Click <strong>Save Changes</strong>.</li>\n</ol>\n<p>KnowBe4 will send verification emails on behalf of the moderation mailbox. These emails will originate from an internal mailbox but from an external KnowBe4 IP address. Therefore, they may be rejected due to SPF misalignment. The gateway hostname should be allowed to spoof the mailbox address within your Microsoft Security Portal to prevent these rejections from happening. To add the gateway as an exception, follow the steps below:</p>\n<ol>\n<li>Log in to your Microsoft Security Portal.</li>\n<li>Navigate to <strong>Policies and Rules </strong>&gt; <strong>Threat Policies </strong>&gt; <strong>Tenant Allow/Block Lists</strong> &gt; <strong>Spoofed senders</strong>.</li>\n<li>Add a new domain pair, including the moderator mailbox email address and the regional gateway address provided by your KnowBe4 engineer.</li>\n</ol>\n<h3 id='h_01JSKM5N19E3TS45RQEQMT454E'>Transport Rules</h3>\n<p>To configure the moderation transport rule, follow the steps below:</p>\n<ol>\n<li>Log in to the Microsoft 365 admin portal.</li>\n<li>Navigate to <strong>Mail Flow </strong>&gt; <strong>Rules</strong> &gt; <strong>Create a new rule</strong>.</li>\n<li>Configure the rule with the following settings:</li>\n</ol>\n<div class='code-block'>\n<button class='copy-btn' data-target='text1'>Copy</button>\n<div id='text1'>\n<pre>Apply this rule if the Header<br>X-MS-Exchange-Organization-AuthMechanism<br>Matches<br>^0?4<br>And is received from<br>Member of group KnowBe4_Prevent_Users@domain.com.<br>Do the following<br>Route the message using the following Connector<br>Exchange Online to Egress<br>And Set the message header<br>X-Egress-Moderation with the value Required<br>Except if<br>Message type is Calendaring<br>Or<br>Message Header X-Switch-Processed contains<br>[GATEWAY ID] this will be provided by you KnowBe4 Engineer<br>Or<br>Message Header X-$Switch matches the following patterns<br>^((?!TPSECONDARY).){1,1000}$</pre>\n</div>\n</div>\n<p>To configure the forward replies to the moderation mailbox transport rule, follow the steps below:</p>\n<ol>\n<li>Log in to the Microsoft 365 admin portal.</li>\n<li>Navigate to <strong>Mail Flow </strong>&gt; <strong>Rules</strong> &gt; <strong>Create a new rule</strong>.</li>\n<li>Configure the rule with the following settings:</li>\n</ol>\n<div class='code-block'>\n<button class='copy-btn' data-target='text2'>Copy</button>\n<div id='text2'>\n<pre><strong>Apply this rule if Received from</strong><br>Inside the Organization<br><strong>And is sent</strong> to recipient KnowBe4_Prevent_Users@domain.com.<br><strong>Do the following</strong><br>Route the message using the connector<br>Exchange Online to Egress<br><strong>And set the Message Header</strong><br>X-Egress-Moderation with the value required<br><strong>Except if the header</strong><br>[GATEWAY ID] this will be provided by your KnowBe4 Engineer\n    </pre>\n</div>\n</div>",
  "user_segment_ids": [],
  "source_url": "https://support.knowbe4.com/hc/en-us/articles/40620770277267-Prevent-Gateway-Configuration",
  "images": [],
  "metadata": {
    "category": "",
    "section": "",
    "topics": [
      "configuration",
      "gateway",
      "prevent"
    ],
    "image_count": 0
  }
}</pre>
</body>
</html>